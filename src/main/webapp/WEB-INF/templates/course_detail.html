<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Color Run | D√©tail de la course</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>


</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col font-poppins">


<!-- Header -->
<div th:replace="fragments/header :: headerFragment(page='home', member=${member})"></div>

<!-- Main Content -->
<main class="flex-1 py-8">
    <div class="container mx-auto px-4 max-w-6xl">

        <!-- Breadcrumb -->
        <nav class="flex mb-6 text-sm text-gray-600">
            <a href="/" class="hover:text-teal-600 transition-colors">Accueil</a>
            <span class="mx-2">‚Ä∫</span>
            <a href="/courses" class="hover:text-teal-600 transition-colors">Courses</a>
            <span class="mx-2">‚Ä∫</span>
            <span class="text-gray-900" th:text="${course.name}">D√©tail de la course</span>
        </nav>

        <!-- Course Header Card -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
            <!-- Header simple -->
            <div class="bg-teal-500 text-white p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold mb-2" th:text="${course.name}">Marathon de Paris</h1>
                        <p class="text-white/90 text-lg" th:text="${course.description}">Un marathon mythique au c≈ìur de Paris</p>
                    </div>
                    <div class="text-right">
                        <div class="bg-white text-teal-500 rounded-lg p-4">
                            <div class="text-3xl font-bold" th:text="${course.price}">50</div>
                            <div class="text-sm text-teal-600">EUR</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Grid - 2 colonnes -->
            <div class="p-6">
                <div class="grid md:grid-cols-2 gap-8">

                    <!-- Colonne gauche : Informations g√©n√©rales -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                            <i data-lucide="info" class="w-5 h-5 mr-2 text-teal-600"></i>
                            Informations g√©n√©rales
                        </h3>

                        <div class="space-y-6">
                            <!-- Date de d√©but -->
                            <div class="flex items-start">
                                <i data-lucide="calendar" class="w-5 h-5 mr-3 text-gray-500 mt-0.5"></i>
                                <div>
                                    <div class="font-medium text-gray-800">Date de d√©but</div>
                                    <div class="text-gray-600" th:text="${course.startDate}">10 avril 2025</div>
                                </div>
                            </div>

                            <!-- Date de fin (optionnelle) -->
                            <div class="flex items-start" th:if="${course.endDate}">
                                <i data-lucide="calendar" class="w-5 h-5 mr-3 text-gray-500 mt-0.5"></i>
                                <div>
                                    <div class="font-medium text-gray-800">Date de fin</div>
                                    <div class="text-gray-600" th:text="${course.endDate}">10 avril 2025</div>
                                </div>
                            </div>

                            <!-- Lieu -->
                            <div class="flex items-start">
                                <i data-lucide="map-pin" class="w-5 h-5 mr-3 text-gray-500 mt-0.5"></i>
                                <div>
                                    <div class="font-medium text-gray-800">Lieu</div>
                                    <div class="text-gray-600">
                                        <div th:text="${course.address}">Champs √âlys√©es</div>
                                        <div>
                                            <span th:text="${course.city}">Paris</span>
                                            (<span th:text="${course.zipCode}">75008</span>)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne droite : Participants & Inscription -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                            <i data-lucide="users" class="w-5 h-5 mr-2 text-teal-600"></i>
                            Participants & Inscription
                        </h3>

                        <div class="space-y-6">
                            <!-- Participants -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-medium text-gray-800">Participants inscrits</div>
                                    <div class="text-lg font-semibold text-teal-600">
                                        <span th:text="${course.currentNumberOfRunners}">1200</span> / <span th:text="${course.maxOfRunners}">5000</span>
                                    </div>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                    <div class="bg-teal-500 h-3 rounded-full transition-all duration-300"
                                         th:style="'width: ' + ${course.currentNumberOfRunners * 100 / course.maxOfRunners} + '%'"></div>
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span th:text="${course.maxOfRunners - course.currentNumberOfRunners}">3800</span> places restantes
                                </div>
                            </div>

                            <!-- Gestion de l'√©tat d'inscription (SANS AJAX) -->
                            <div id="inscription-status">

                                <!-- Cas 1: Utilisateur non connect√© -->
                                <div th:if="${member == null}">
                                    <a th:href="@{/login(redirect=${'/course-detail?id=' + course.id})}"
                                       class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-4 rounded-lg transition-colors flex items-center justify-center text-lg block text-center no-underline">
                                        <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
                                        Se connecter pour s'inscrire
                                    </a>
                                </div>

                                <!-- Cas 2: Utilisateur connect√© ET inscrit ET pay√© -->
                                <div th:if="${member != null and isUserPaid and member.role.name() != 'ADMIN' and member.role.name() != 'ORGANIZER'}"
                                     class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-2"></i>
                                        <span class="text-green-800 font-medium">Vous √™tes inscrit √† cette course</span>
                                    </div>
                                    <p class="text-green-700 text-sm mt-1">Votre inscription a √©t√© confirm√©e avec succ√®s et le paiement a √©t√© effectu√©.</p>

                                    <!-- Section chat (uniquement pour les inscrits pay√©s) -->
                                    <div class="mt-4 pt-4 border-t border-green-200">
                                        <h4 class="font-medium text-green-800 mb-2 flex items-center">
                                            <i data-lucide="message-circle" class="w-4 h-4 mr-2"></i>
                                            Chat de la course
                                        </h4>
                                        <a href="#chat-section" onclick="accessChat()" id="access-chat-btn"
                                           class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                            <i data-lucide="message-square" class="w-4 h-4 mr-2"></i>
                                            Acc√©der au chat
                                        </a>
                                    </div>
                                </div>

                                <!-- Cas 2bis: Mod√©rateurs avec acc√®s privil√©gi√© -->
                                <div th:if="${member != null and isUserPaid and (member.role.name() == 'ADMIN' or member.role.name() == 'ORGANIZER')}"
                                     class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i data-lucide="shield-check" class="w-5 h-5 text-blue-600 mr-2"></i>
                                        <span class="text-blue-800 font-medium">Acc√®s mod√©rateur autoris√©</span>
                                    </div>
                                    <p class="text-blue-700 text-sm mt-1">
                                        Vous acc√©dez √† cette course en tant que
                                        <span th:text="${member.role.name() == 'ADMIN' ? 'Administrateur' : 'Organisateur'}" class="font-medium"></span>.
                                        Aucune inscription n'est requise.
                                    </p>

                                    <!-- Section chat pour mod√©rateurs -->
                                    <div class="mt-4 pt-4 border-t border-blue-200">
                                        <h4 class="font-medium text-blue-800 mb-2 flex items-center">
                                            <i data-lucide="message-circle" class="w-4 h-4 mr-2"></i>
                                            Chat de mod√©ration
                                        </h4>
                                        <a href="#chat-section" onclick="accessChat()" id="access-chat-btn"
                                           class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                            <i data-lucide="shield" class="w-4 h-4 mr-2"></i>
                                            Acc√©der au chat
                                        </a>
                                    </div>
                                </div>

                                <!-- Cas 3: Utilisateur connect√© mais inscription en cours ou pas pay√© -->
                                <div th:if="${member != null and isUserRegistered and !isUserPaid}" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i data-lucide="clock" class="w-5 h-5 text-yellow-600 mr-2"></i>
                                        <span class="text-yellow-800 font-medium">Inscription en cours de traitement</span>
                                    </div>
                                    <p class="text-yellow-700 text-sm mt-1">Votre inscription est en attente de confirmation de paiement.</p>
                                </div>

                                <!-- Cas 4: Utilisateur connect√© mais pas inscrit - TOUJOURS PAYANT -->
                                <div th:if="${member != null and !isUserRegistered}">
                                    <button id="inscription-btn-stripe"
                                            th:data-course-id="${course.id}"
                                            th:data-course-name="${course.name}"
                                            th:data-price="${course.price}"
                                            class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-4 px-4 rounded-lg transition-colors flex items-center justify-center text-lg">
                                        <i data-lucide="credit-card" class="w-5 h-5 mr-2"></i>
                                        Payer et s'inscrire - <span th:text="${course.price}">50</span>‚Ç¨
                                    </button>
                                </div>

                                <!-- Messages d'erreur/succ√®s depuis les param√®tres URL -->
                                <div th:if="${param.success}" class="mt-4 bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-2"></i>
                                        <span class="text-green-800 font-medium">
                                            <span th:if="${param.success[0] == 'payment_completed'}">Paiement effectu√© avec succ√®s !</span>
                                            <span th:if="${param.success[0] == 'registration_completed'}">Inscription confirm√©e !</span>
                                        </span>
                                    </div>
                                </div>

                                <div th:if="${param.error}" class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mr-2"></i>
                                        <span class="text-red-800 font-medium">
                                            <span th:if="${param.error[0] == 'registration_failed'}">Erreur lors de l'inscription</span>
                                            <span th:if="${param.error[0] == 'payment_failed'}">Erreur lors du paiement</span>
                                            <span th:if="${param.error[0] == 'course_expired'}">Cette course a d√©j√† eu lieu</span>
                                            <span th:unless="${param.error[0] == 'registration_failed' or param.error[0] == 'payment_failed' or param.error[0] == 'course_expired'}">Une erreur est survenue</span>
                                        </span>
                                    </div>
                                </div>

                                <div th:if="${param.info}" class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-2"></i>
                                        <span class="text-blue-800 font-medium">
                                            <span th:if="${param.info[0] == 'payment_cancelled'}">Paiement annul√©</span>
                                            <span th:unless="${param.info[0] == 'payment_cancelled'}">Information</span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Informations organisateur -->
                            <div class="border border-yellow-200 bg-yellow-50 rounded-lg p-4">
                                <h4 class="font-medium text-yellow-800 mb-3 flex items-center">
                                    <i data-lucide="info" class="w-4 h-4 mr-2"></i>
                                    Informations organisateur
                                </h4>
                                <div class="space-y-2 text-sm text-yellow-700">
                                    <div class="flex items-center">
                                        <i data-lucide="building" class="w-3 h-3 mr-2"></i>
                                        <span>Association n¬∞<span th:text="${course.associationId}" class="font-medium">1</span></span>
                                    </div>
                                    <div class="flex items-center">
                                        <i data-lucide="user" class="w-3 h-3 mr-2"></i>
                                        <span>Cr√©√© par le membre n¬∞<span th:text="${course.memberCreatorId}" class="font-medium">42</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Chat - Toujours visible mais peut √™tre r√©duite -->
        <div th:if="${member != null and isUserPaid}" id="chat-section" class="">
            <div th:if="${member.role.name() == 'ADMIN' or member.role.name() == 'ORGANIZER'}"
                 class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded-r-lg">
                <div class="flex items-center">
                    <i data-lucide="shield-check" class="w-5 h-5 text-yellow-600 mr-2"></i>
                    <div>
                        <p class="text-yellow-800 font-medium">Acc√®s mod√©rateur</p>
                        <p class="text-yellow-700 text-sm">Vous acc√©dez au chat en tant que
                            <span th:text="${member.role.name() == 'ADMIN' ? 'Administrateur' : 'Organisateur'}"></span>
                        </p>
                    </div>
                </div>
            </div>
            <div th:replace="fragments/chat :: chatFragment(${course.id}, ${member})"></div>
        </div>

        <!-- Map Section -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
            <div class="p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="map" class="w-5 h-5 mr-2 text-teal-600"></i>
                    Localisation de la course
                </h2>

                <div id="map-container" class="h-96 w-full border rounded-lg relative shadow-sm">
                    <div class="absolute inset-0 bg-gray-100 flex items-center justify-center z-0 rounded-lg">
                        <div class="text-center">
                            <i data-lucide="map-pin" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Chargement de la carte...</p>
                        </div>
                    </div>

                    <!-- Map Legend -->
                    <div class="absolute bottom-4 left-4 bg-white p-3 rounded-lg shadow-md z-10 border">
                        <h4 class="font-semibold text-sm mb-2 text-gray-800">L√©gende</h4>
                        <div class="space-y-1">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-teal-500 mr-2"></div>
                                <p class="text-xs text-gray-700">D√©part</p>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-pink-500 mr-2"></div>
                                <p class="text-xs text-gray-700">Arriv√©e</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-between items-center">
            <a href="/courses" class="inline-flex items-center bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                Retour √† la liste
            </a>

            <a href="/" class="inline-flex items-center bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                <i data-lucide="home" class="w-4 h-4 mr-2"></i>
                Retour √† l'accueil
            </a>
        </div>
    </div>
</main>

<!-- Footer -->
<footer class="bg-white border-t p-4 mt-auto">
    <div class="container mx-auto px-4 text-center">
        <p class="text-sm text-gray-500">&copy; 2025 Color Run. Tous droits r√©serv√©s.</p>
    </div>
</footer>

<!-- Stripe JavaScript SDK -->
<script src="https://js.stripe.com/v3/"></script>
<!-- Initialize Lucide Icons and Map -->
<script th:inline="javascript">
    const courseId = /*[[${course.id}]]*/;
    const memberId = /*[[${member != null ? member.id : 'null'}]]*/;
    const isUserConnected = /*[[${member != null ? 'true' : 'false'}]]*/ === 'true';
    const isUserRegistered = /*[[${isUserRegistered}]]*/ || false;
    const isUserPaid = /*[[${isUserPaid}]]*/ || false;

    console.log('üîç Variables de session:');
    console.log('  - Course ID:', courseId);
    console.log('  - Member ID:', memberId);
    console.log('  - User connected:', isUserConnected);
    console.log('  - User registered:', isUserRegistered);
    console.log('  - User paid:', isUserPaid);

    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        initializeCourseMap();
        initializeStripePayment();
    });

    function initializeChat() {
        console.log('üí¨ Initialisation du chat pour la course:', courseId);

        // Le chat sera g√©r√© par le fragment chat.html
        // On peut ajouter ici des √©v√©nements sp√©cifiques si n√©cessaire

        // Charger les messages existants
        loadChatMessages();

        // Activer le polling pour les nouveaux messages (toutes les 3 secondes)
        // setInterval(loadChatMessages, 3000);
        console.log('üìù Chat g√©r√© par le fragment - pas de polling ici');
    }

    function loadChatMessages() {
        // Cette fonction sera d√©finie dans le fragment chat
        if (window.chatApp && window.chatApp.loadMessages) {
            console.log('üîÑ Appel loadMessages via fragment');
            window.chatApp.loadMessages();
        } else {
            console.log('chatApp non disponible');
        }
    }

    // Fonction pour acc√©der au chat (ancre + d√©plier si n√©cessaire)
    function accessChat() {
        console.log('üîó Acc√®s au chat demand√©');

        const chatContent = document.getElementById('chat-content');
        const toggleBtn = document.getElementById('toggle-chat-content-btn');
        const toggleText = document.getElementById('chat-toggle-text');
        const chevronIcon = toggleBtn?.querySelector('i[data-lucide]');

        // Si le chat est repli√©, le d√©plier automatiquement
        if (chatContent && chatContent.style.display === 'none') {
            chatContent.style.display = 'block';
            if (toggleText) toggleText.textContent = 'R√©duire';
            if (chevronIcon) chevronIcon.setAttribute('data-lucide', 'chevron-up');

            // R√©initialiser les ic√¥nes Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            console.log('Chat d√©pli√© automatiquement');
        }

        // Initialiser le chat si pas encore fait
        if (window.chatApp && window.chatApp.init) {
            window.chatApp.init();
        }

        // Faire d√©filer vers le chat apr√®s un petit d√©lai pour l'animation
        setTimeout(() => {
            const chatSection = document.getElementById('chat-section');
            if (chatSection) {
                chatSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start',
                    inline: 'nearest'
                });
            }
        }, 150);
    }

    function initializeCourseMap() {
        // R√©cup√©rer les donn√©es de la course depuis Thymeleaf
        const course = {
            name: /*[[${course.name}]]*/ "Course par d√©faut",
            startpositionLatitude: /*[[${course.startpositionLatitude}]]*/ 48.8566,
            startpositionLongitude: /*[[${course.startpositionLongitude}]]*/ 2.3522,
            endpositionLatitude: /*[[${course.endpositionLatitude}]]*/ 48.8606,
            endpositionLongitude: /*[[${course.endpositionLongitude}]]*/ 2.3376
        };

        if (course.startpositionLatitude && course.startpositionLongitude) {
            const map = L.map('map-container').setView([course.startpositionLatitude, course.startpositionLongitude], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Marqueur de d√©part (teal)
            const startIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background-color: #14b8a6; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            const startMarker = L.marker([course.startpositionLatitude, course.startpositionLongitude], {icon: startIcon})
                .addTo(map)
                .bindPopup(`
                    <div style="font-family: 'Poppins', sans-serif; padding: 12px; max-width: 200px;">
                        <h3 style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: #14b8a6;">üèÅ Point de d√©part</h3>
                        <p style="font-size: 14px; color: #374151; margin: 0;">${course.name}</p>
                        <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">D√©but de la course</p>
                    </div>
                `);

            // Marqueur d'arriv√©e (pink) - seulement si diff√©rent du d√©part
            if (course.endpositionLatitude !== course.startpositionLatitude ||
                course.endpositionLongitude !== course.startpositionLongitude) {

                const endIcon = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background-color: #ec4899; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const endMarker = L.marker([course.endpositionLatitude, course.endpositionLongitude], {icon: endIcon})
                    .addTo(map)
                    .bindPopup(`
                        <div style="font-family: 'Poppins', sans-serif; padding: 12px; max-width: 200px;">
                            <h3 style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: #ec4899;">Point d'arriv√©e</h3>
                            <p style="font-size: 14px; color: #374151; margin: 0;">${course.name}</p>
                            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Fin de la course</p>
                        </div>
                    `);

                // Ajuster la vue pour montrer les deux marqueurs
                const group = new L.featureGroup([startMarker, endMarker]);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
    }

    // Fonction pour g√©rer le paiement Stripe
    function initializeStripePayment() {
        console.log('üîß Initialisation du paiement Stripe');

        // Bouton paiement Stripe
        const inscriptionBtnStripe = document.getElementById('inscription-btn-stripe');
        // Bouton inscription gratuite
        const inscriptionBtnFree = document.getElementById('inscription-btn-free');

        console.log('Boutons trouv√©s:', {
            stripe: !!inscriptionBtnStripe,
            free: !!inscriptionBtnFree
        });

        // Gestion inscription gratuite
        if (inscriptionBtnFree) {
            console.log('üÜì Configuration bouton inscription gratuite');
            inscriptionBtnFree.addEventListener('click', function() {
                const courseId = this.getAttribute('data-course-id');
                const courseName = this.getAttribute('data-course-name');

                console.log('Inscription gratuite demand√©e:', { courseId, courseName });

                // D√©sactiver le bouton
                this.disabled = true;
                this.innerHTML = '<div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-2"></div>Inscription...';

                // Envoyer la demande d'inscription
                fetch('/color_run_war/inscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `courseId=${courseId}`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert(data.message);
                            this.disabled = false;
                            this.innerHTML = '<i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>S\'inscrire gratuitement';
                            lucide.createIcons();
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        alert('Erreur lors de l\'inscription: ' + error.message);
                        this.disabled = false;
                        this.innerHTML = '<i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>S\'inscrire gratuitement';
                        lucide.createIcons();
                    });
            });
        }

        // Gestion paiement Stripe
        if (inscriptionBtnStripe) {
            console.log('Configuration bouton paiement Stripe');
            inscriptionBtnStripe.addEventListener('click', function() {
                const courseId = this.getAttribute('data-course-id');
                const courseName = this.getAttribute('data-course-name');
                const price = this.getAttribute('data-price');

                console.log('Inscription avec paiement demand√©e:', { courseId, courseName, price });

                // D√©sactiver le bouton pendant le traitement
                this.disabled = true;
                this.innerHTML = '<div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-2"></div>Traitement...';

                // Cr√©er la session de paiement
                fetch('/color_run_war/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `courseId=${courseId}&courseName=${encodeURIComponent(courseName)}&price=${price}`
                })
                    .then(response => {
                        console.log('R√©ponse du serveur:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Donn√©es re√ßues:', data);
                        if (data.error) {
                            throw new Error(data.error);
                        }

                        // V√©rifier qu'on a bien re√ßu un ID de session
                        if (!data.id) {
                            throw new Error('Aucun ID de session re√ßu du serveur');
                        }

                        console.log('üîë ID de session Stripe:', data.id);

                        const stripePublicKey = 'pk_test_51RZVAjPsYYsWDUGNaF1qIxOE8wdvyyaTyHvNEjNk1w0hHZsr2dH8sgHHvFGy8mBMxeRUmxUZjdhwSji8yTAKCa6d00JILg5DZc';
                        const stripe = Stripe(stripePublicKey);

                        console.log('Redirection vers Stripe Checkout...');
                        return stripe.redirectToCheckout({ sessionId: data.id });
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        alert('Erreur lors de la cr√©ation de la session de paiement: ' + error.message);

                        // R√©activer le bouton
                        this.disabled = false;
                        this.innerHTML = '<i data-lucide="credit-card" class="w-5 h-5 mr-2"></i>Payer et s\'inscrire - ' + price + '‚Ç¨';
                        lucide.createIcons();
                    });
            });
        }

        console.log('Initialisation du paiement termin√©e');
    }
</script>

</body>
</html>