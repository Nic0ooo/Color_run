<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="chatFragment(courseId, member)">
<head>
    <meta charset="UTF-8">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" th:href="@{/css/chat.css}">
</head>
<body>

<!-- Chat Section - Visible uniquement pour les participants inscrits et pay√©s -->
<div id="chat-section" class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i data-lucide="message-circle" class="w-5 h-5 mr-2"></i>
                <div>
                    <h2 class="text-xl font-semibold">Chat de la course</h2>
                    <p class="text-white/90 text-sm mt-1">√âchangez avec les autres participants</p>
                </div>
            </div>
            <button onclick="toggleChatContent()" id="toggle-chat-content-btn"
                    class="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-lg transition-colors text-sm flex items-center">
                <i data-lucide="chevron-up" class="w-4 h-4 mr-1"></i>
                <span id="chat-toggle-text">R√©duire</span>
            </button>
        </div>
    </div>

    <div id="chat-content" class="p-4">
        <!-- Zone des messages -->
        <div id="messages-container" class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto mb-4 border">
            <div id="messages-list" class="space-y-3">
                <!-- Message de bienvenue par d√©faut -->
                <div class="flex justify-start message-item">
                    <div class="max-w-xs lg:max-w-md bg-blue-100 border border-blue-300 rounded-lg px-4 py-3 shadow-sm">
                        <div class="text-xs font-medium text-blue-800 mb-1">üèÉ‚Äç‚ôÇÔ∏è Organisateur</div>
                        <div class="text-sm">Bienvenue dans le chat de la course ! Merci pour votre inscription. Vous pouvez d√©sormais √©changer avec les autres participants.</div>
                        <div class="text-xs text-blue-600 mt-1">Maintenant</div>
                    </div>
                </div>

                <!-- Messages charg√©s dynamiquement -->
                <div id="loading-messages" class="text-center text-gray-500 py-4">
                    <div class="animate-spin w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                    <p>Chargement des messages...</p>
                </div>

                <!-- Message par d√©faut si aucun message -->
                <div id="no-messages" class="text-center text-gray-500 py-8 hidden">
                    <i data-lucide="message-square-plus" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                    <p>Aucun message pour le moment.</p>
                    <p class="text-sm">Soyez le premier √† commencer la conversation !</p>
                </div>
            </div>
        </div>

        <!-- Formulaire d'envoi de message -->
        <form id="chat-form" class="flex gap-3">
            <div class="flex-1">
                <textarea
                        id="message-input"
                        placeholder="Tapez votre message ici..."
                        rows="2"
                        maxlength="1000"
                        class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                        required></textarea>
                <div class="text-right text-xs text-gray-500 mt-1">
                    <span id="char-count">0</span>/1000 caract√®res
                </div>
            </div>
            <div class="flex flex-col justify-start">
                <button
                        type="submit"
                        id="send-button"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors flex items-center justify-center h-fit">
                    <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                    Envoyer
                </button>
            </div>
        </form>

        <!-- Statut de connexion -->
        <div id="connection-status" class="mt-3 text-sm text-gray-600 flex items-center">
            <div id="status-indicator" class="w-2 h-2 rounded-full mr-2 bg-green-500"></div>
            <span id="status-text">Connect√©</span>
        </div>
    </div>
</div>

<!-- Script JavaScript pour le chat -->
<script th:inline="javascript">
    (function() {
        // Configuration du chat
        const CHAT_CONFIG = {
            courseId: /*[[${courseId}]]*/ null,
            memberId: /*[[${member.id}]]*/ null,
            memberName: /*[[${member.firstname + ' ' + member.name}]]*/ 'Utilisateur',
            memberRole: /*[[${member.role}]]*/ 'RUNNER',
            refreshInterval: 3000, // 3 secondes
            maxMessages: 100
        };

        console.log('üí¨ Initialisation du chat avec config:', CHAT_CONFIG);

        // Variables globales du chat
        let chatApp = {
            isLoading: false,
            lastMessageId: 0,
            refreshTimer: null,
            isInitialized: false,
            currentUserIsModerator: false,

            // √âl√©ments DOM
            elements: {
                messagesList: null,
                messageInput: null,
                sendButton: null,
                chatForm: null,
                charCount: null,
                loadingMessages: null,
                noMessages: null,
                statusIndicator: null,
                statusText: null,
                messagesContainer: null
            },

            // Initialisation
            init: function() {
                if (this.isInitialized) {
                    console.log('Chat d√©j√† initialis√©');
                    return;
                }

                if (!CHAT_CONFIG.memberId || CHAT_CONFIG.memberId === 'null') {
                    console.log('Utilisateur non connect√© - Chat non initialis√©');
                    this.stopPolling();
                    return;
                }

                console.log('Initialisation du chat pour la course:', CHAT_CONFIG.courseId);

                // R√©cup√©ration des √©l√©ments DOM
                this.elements.messagesList = document.getElementById('messages-list');
                this.elements.messageInput = document.getElementById('message-input');
                this.elements.sendButton = document.getElementById('send-button');
                this.elements.chatForm = document.getElementById('chat-form');
                this.elements.charCount = document.getElementById('char-count');
                this.elements.loadingMessages = document.getElementById('loading-messages');
                this.elements.noMessages = document.getElementById('no-messages');
                this.elements.statusIndicator = document.getElementById('status-indicator');
                this.elements.statusText = document.getElementById('status-text');
                this.elements.messagesContainer = document.getElementById('messages-container');

                // V√©rification des √©l√©ments critiques
                if (!this.elements.messagesList || !this.elements.messageInput || !this.elements.chatForm) {
                    console.error('√âl√©ments DOM du chat non trouv√©s');
                    return;
                }

                // Initialisation des √©v√©nements
                this.initializeEvents();

                // Chargement initial des messages
                this.loadMessages(true);

                // D√©marrage du polling
                this.startPolling();

                this.isInitialized = true;
                console.log('Chat initialis√© avec succ√®s');
            },

            // Initialisation des √©v√©nements
            initializeEvents: function() {
                // Soumission du formulaire
                this.elements.chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });

                // Compteur de caract√®res
                this.elements.messageInput.addEventListener('input', () => {
                    const length = this.elements.messageInput.value.length;
                    this.elements.charCount.textContent = length;

                    // Changer la couleur si pr√®s de la limite
                    if (length > 900) {
                        this.elements.charCount.classList.add('text-red-500');
                        this.elements.charCount.classList.remove('text-yellow-500');
                    } else if (length > 800) {
                        this.elements.charCount.classList.add('text-yellow-500');
                        this.elements.charCount.classList.remove('text-red-500');
                    } else {
                        this.elements.charCount.classList.remove('text-red-500', 'text-yellow-500');
                    }
                });

                // Raccourci clavier (Ctrl+Enter ou Cmd+Enter pour envoyer)
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                console.log('üìù √âv√©nements du chat initialis√©s');
            },

            // Chargement des messages
            loadMessages: function(showLoader = false) {
                if (this.isLoading) return;

                if (!CHAT_CONFIG.memberId || CHAT_CONFIG.memberId === 'null') {
                    console.log('Pas d\'authentification - Arr√™t du polling');
                    this.stopPolling();
                    return;
                }

                this.isLoading = true;
                if (showLoader) {
                    this.showLoadingState(true);
                }

                const url = `/color_run_war/chat/messages?courseId=${CHAT_CONFIG.courseId}&lastMessageId=${this.lastMessageId}`;

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (showLoader) {
                            console.log('üì® Messages re√ßus:', data.messages?.length || 0);
                        }

                        // Mettre √† jour le statut de mod√©rateur
                        this.currentUserIsModerator = data.isCurrentUserModerator || false;
                        console.log('üõ°Statut mod√©rateur mis √† jour:', this.currentUserIsModerator);

                        this.displayMessages(data.messages || []);
                        this.updateConnectionStatus(true);
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement des messages:', error);
                        this.updateConnectionStatus(false);
                        if (showLoader) {
                            this.showError('Erreur lors du chargement des messages');
                        }
                    })
                    .finally(() => {
                        this.isLoading = false;
                        if (showLoader) {
                            this.showLoadingState(false);
                        }
                    });
            },

            // Affichage des messages
            displayMessages: function(messages) {
                if (!messages || messages.length === 0) {
                    // Ne pas afficher "aucun message" s'il y a d√©j√† le message de bienvenue
                    return;
                }

                this.elements.noMessages.classList.add('hidden');

                // Supprimer les indicateurs de chargement
                if (this.elements.loadingMessages) {
                    this.elements.loadingMessages.style.display = 'none';
                }

                messages.forEach(message => {
                    if (message.id > this.lastMessageId) {
                        this.addMessageToDOM(message);
                        this.lastMessageId = message.id;
                    }
                });

                // Scroll vers le bas pour voir les nouveaux messages
                this.scrollToBottom();
            },

            // Ajout d'un message au DOM
            addMessageToDOM: function(message) {
                const messageElement = document.createElement('div');
                const isOwnMessage = message.memberId === CHAT_CONFIG.memberId;
                const isDeleted = message.isHidden || message.isDeleted;
                const isPinned = message.isPin;

                messageElement.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} message-item`;
                messageElement.setAttribute('data-message-id', message.id);

                // Construire le contenu avec logique d'affichage
                let contentHtml;
                if (isDeleted) {
                    // Message masqu√© - Afficher dans un encart style WhatsApp
                    const deleteText = message.isDeleted ?
                        "*Message supprim√© par l'utilisateur*" :
                        "*Message masqu√© par la mod√©ration*";

                    contentHtml = `
                    <div class="message-deleted-container">
                        <!-- Encart gris√© avec ic√¥ne -->
                        <div class="bg-gray-100 border-l-4 border-gray-400 rounded-r-lg p-3 italic text-gray-600">
                            <div class="flex items-center mb-2">
                                <i data-lucide="eye-off" class="w-3 h-3 mr-2 text-gray-500"></i>
                                <span class="text-xs font-medium">${deleteText}</span>
                            </div>

                            <!-- Contenu original masqu√© par d√©faut -->
                            ${message.originalContent ? `
                            <div class="original-message-toggle">
                                <button onclick="toggleOriginalMessage(${message.id})"
                                        class="text-xs text-blue-600 hover:text-blue-800 underline">
                                    Afficher le message original
                                </button>
                                <div id="original-message-${message.id}" class="hidden mt-2 p-2 bg-white rounded border text-gray-700 text-sm">
                                    ${this.escapeHtml(message.originalContent)}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                } else {
                    // Message normal
                    contentHtml = `
                        <div class="text-sm whitespace-pre-wrap">
                            ${this.escapeHtml(message.content)}
                        </div>
                    `;
                }

                const messageContent = `
                    <div class="max-w-xs lg:max-w-md ${isOwnMessage ? 'bg-blue-500 text-white' : 'bg-white border'} ${isDeleted ? 'opacity-80' : ''} ${isPinned ? 'ring-2 ring-yellow-400' : ''} rounded-lg px-4 py-3 shadow-sm relative group">

                        ${isPinned ? '<div class="absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 rounded-full p-1"><i data-lucide="pin" class="w-3 h-3"></i></div>' : ''}

                        ${!isOwnMessage ? `<div class="text-xs font-medium text-gray-600 mb-1">${this.escapeHtml(message.memberName)}</div>` : ''}

                        ${contentHtml}

                        <div class="text-xs ${isOwnMessage ? 'text-blue-100' : 'text-gray-500'} mt-1 flex items-center justify-between">
                            <span>${this.formatDate(message.date)}</span>

                            <!-- CORRECTION : Actions visibles pour TOUS les messages si on est mod√©rateur -->
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">

                                <!-- Boutons pour l'auteur du message (comme avant) -->
                                ${isOwnMessage && !isDeleted ? `
                                    <button onclick="window.chatApp.editOwnMessage(${message.id})"
                                            class="text-blue-600 hover:text-blue-800 transition-colors"
                                            title="Modifier ce message">
                                        <i data-lucide="edit-3" class="w-3 h-3"></i>
                                    </button>
                                    <button onclick="window.chatApp.hideOwnMessage(${message.id})"
                                            class="text-orange-500 hover:text-orange-700 transition-colors"
                                            title="Supprimer ce message">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                ` : ''}

                                <!-- NOUVEAU : Boutons mod√©ration visibles sur TOUS les messages pour les mod√©rateurs -->
                                ${this.currentUserIsModerator ? `
                                    <!-- S√©parateur visuel si c'est son propre message ET on a des actions mod√©rateur -->
                                    ${isOwnMessage && !isDeleted ? '<span class="text-gray-400">|</span>' : ''}

                                    <!-- Pin/Unpin disponible sur tous les messages non supprim√©s -->
                                    ${!isDeleted ? `
                                        <button onclick="window.chatApp.togglePinMessage(${message.id})"
                                                class="text-yellow-600 hover:text-yellow-800 transition-colors"
                                                title="${isPinned ? 'D√©s√©pingler' : '√âpingler'} ce message">
                                            <i data-lucide="${isPinned ? 'pin-off' : 'pin'}" class="w-3 h-3"></i>
                                        </button>
                                    ` : ''}

                                    <!-- Masquer disponible sur tous les messages non supprim√©s (m√™me pour les autres utilisateurs) -->
                                    ${!isDeleted ? `
                                        <button onclick="window.chatApp.hideMessage(${message.id})"
                                                class="text-orange-600 hover:text-orange-800 transition-colors"
                                                title="Masquer ce message">
                                            <i data-lucide="eye-off" class="w-3 h-3"></i>
                                        </button>
                                    ` : ''}
                                ` : ''}

                                <!-- S√âPAR√â : Suppression d√©finitive UNIQUEMENT pour les ADMIN -->
                                ${this.currentUserIsModerator && CHAT_CONFIG.memberRole === 'ADMIN' ? `
                                    <button onclick="window.chatApp.deleteMessage(${message.id})"
                                            class="text-red-600 hover:text-red-800 transition-colors"
                                            title="Supprimer d√©finitivement">
                                        <i data-lucide="x-circle" class="w-3 h-3"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;


                messageElement.innerHTML = messageContent;
                this.elements.messagesList.appendChild(messageElement);

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            },

            // Envoi d'un message
            sendMessage: function() {
                const content = this.elements.messageInput.value.trim();

                if (!content) {
                    return;
                }

                if (content.length > 1000) {
                    this.showError('Message trop long (maximum 1000 caract√®res)');
                    return;
                }

                // D√©sactiver le formulaire pendant l'envoi
                this.setFormEnabled(false);

                const messageData = {
                    courseId: CHAT_CONFIG.courseId,
                    content: content
                };

                fetch('/color_run_war/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(messageData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            console.log('Message envoy√© avec succ√®s');
                            this.elements.messageInput.value = '';
                            this.elements.charCount.textContent = '0';
                            this.elements.charCount.classList.remove('text-red-500', 'text-yellow-500');

                            // Recharger les messages pour voir le nouveau message
                            this.loadMessages(true);
                        } else {
                            throw new Error(data.message || 'Erreur lors de l\'envoi du message');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de l\'envoi du message:', error);
                        this.showError('Erreur lors de l\'envoi du message: ' + error.message);
                    })
                    .finally(() => {
                        this.setFormEnabled(true);
                    });
            },

            // Nouvelle fonction : Modification d'un message par l'auteur
            editOwnMessage: function(messageId) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (!messageElement) return;

                const contentDiv = messageElement.querySelector('.text-sm.whitespace-pre-wrap');
                if (!contentDiv) return;

                const currentContent = contentDiv.textContent.trim();

                const newContent = prompt('Modifier votre message:', currentContent);
                if (newContent === null || newContent.trim() === currentContent) {
                    return; // Annul√© ou pas de changement
                }

                if (newContent.trim() === '') {
                    alert('Le message ne peut pas √™tre vide');
                    return;
                }

                if (newContent.length > 1000) {
                    alert('Message trop long (maximum 1000 caract√®res)');
                    return;
                }

                console.log('‚úèÔ∏è Modification du message:', messageId);
                this.callAPI('/color_run_war/chat/update', {
                    messageId: messageId,
                    content: newContent.trim()
                });
            },

            // Pour l'utilisateur - masquer son propre message
            hideOwnMessage: function(messageId) {
                if (!confirm('Supprimer ce message ?\n\nIl sera remplac√© par "*Message supprim√© par l\'utilisateur*".')) {
                    return;
                }

                console.log('üóëÔ∏è Suppression du message par l\'utilisateur:', messageId);
                this.callAPI('/color_run_war/chat/delete-own', {
                    messageId: messageId
                });
            },

            // üõ°Pour les mod√©rateurs - masquer n'importe quel message
            hideMessage: function(messageId) {
                if (!confirm('Masquer ce message en tant que mod√©rateur ?')) {
                    return;
                }

                console.log('Masquage du message par mod√©rateur:', messageId);

                // 1. MISE √Ä JOUR VISUELLE IMM√âDIATE
                this.updateMessageVisually(messageId, 'hidden');

                // 2. Appel API en arri√®re-plan
                this.callAPI('/color_run_war/chat/moderate', {
                    messageId: messageId,
                    action: 'hide'
                });
            },

            // üóëPour les mod√©rateurs - suppression d√©finitive
            deleteMessage: function(messageId) {
                if (!confirm('‚ö†Ô∏è SUPPRIMER D√âFINITIVEMENT ce message ?')) {
                    return;
                }

                if (!confirm('DERNI√àRE CONFIRMATION')) {
                    return;
                }

                console.log('Suppression d√©finitive par mod√©rateur:', messageId);

                // 1. SUPPRESSION VISUELLE IMM√âDIATE
                this.updateMessageVisually(messageId, 'deleted');

                // 2. Appel API en arri√®re-plan
                this.callAPI('/color_run_war/chat/moderate', {
                    messageId: messageId,
                    action: 'delete'
                });
            },

            // Pour les mod√©rateurs - √©pingler/d√©s√©pingler
            togglePinMessage: function(messageId) {
                console.log('Toggle pin message:', messageId);

                // 1. MISE √Ä JOUR VISUELLE IMM√âDIATE
                this.updateMessageVisually(messageId, 'pin');

                // 2. Appel API en arri√®re-plan
                this.callAPI('/color_run_war/chat/moderate', {
                    messageId: messageId,
                    action: 'pin'
                });
            },

            updateMessageVisually: function(messageId, action) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (!messageElement) {
                    console.warn('Message element non trouv√©:', messageId);
                    return;
                }

                console.log('Mise √† jour visuelle:', action, 'pour message', messageId);

                if (action === 'hidden') {
                    // Remplacer par le message "masqu√© par la mod√©ration"
                    const contentDiv = messageElement.querySelector('.text-sm.whitespace-pre-wrap') ||
                        messageElement.querySelector('.message-deleted-container');

                    if (contentDiv) {
                        contentDiv.innerHTML = `
                <div class="bg-gray-100 border-l-4 border-gray-400 rounded-r-lg p-3 italic text-gray-600">
                    <div class="flex items-center">
                        <i data-lucide="eye-off" class="w-3 h-3 mr-2 text-gray-500"></i>
                        <span class="text-xs font-medium">*Message masqu√© par la mod√©ration*</span>
                    </div>
                </div>
            `;

                        // R√©initialiser les ic√¥nes Lucide
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    }

                } else if (action === 'deleted') {
                    // Supprimer compl√®tement l'√©l√©ment
                    messageElement.style.opacity = '0';
                    messageElement.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => {
                        messageElement.remove();
                    }, 300);

                } else if (action === 'pin') {
                    // Basculer l'√©pingle visuelle
                    const pinIcon = messageElement.querySelector('.absolute.-top-2.-right-2');
                    const messageContainer = messageElement.querySelector('.max-w-xs.lg\\:max-w-md');

                    if (pinIcon) {
                        // D√©j√† √©pingl√©, le d√©s√©pingler
                        pinIcon.remove();
                        if (messageContainer) {
                            messageContainer.classList.remove('ring-2', 'ring-yellow-400');
                        }
                    } else {
                        // Pas √©pingl√©, l'√©pingler
                        const pinElement = document.createElement('div');
                        pinElement.className = 'absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 rounded-full p-1';
                        pinElement.innerHTML = '<i data-lucide="pin" class="w-3 h-3"></i>';

                        if (messageContainer) {
                            messageContainer.classList.add('ring-2', 'ring-yellow-400');
                            messageContainer.style.position = 'relative';
                            messageContainer.appendChild(pinElement);
                        }

                        // R√©initialiser les ic√¥nes Lucide
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    }
                }
            },

            // M√©thode commune pour les appels API
            callAPI: function(url, data) {
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            console.log('Action r√©ussie:', data.message);

                            if (url.includes('/moderate') && data.action === 'delete') {
                                // Pour une suppression d√©finitive, supprimer visuellement
                                const messageElement = document.querySelector(`[data-message-id="${data.messageId}"]`);
                                if (messageElement) {
                                    messageElement.remove();
                                }
                            } else {
                                // Pour les autres actions, recharger les messages
                                this.loadMessages(true);
                            }
                        } else {
                            throw new Error(data.message || 'Erreur lors de l\'action');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de l\'action:', error);
                        this.showError('Erreur: ' + error.message);
                    });
            },

            // Activation/d√©sactivation du formulaire
            setFormEnabled: function(enabled) {
                this.elements.messageInput.disabled = !enabled;
                this.elements.sendButton.disabled = !enabled;

                if (enabled) {
                    this.elements.sendButton.innerHTML = '<i data-lucide="send" class="w-4 h-4 mr-2"></i>Envoyer';
                    this.elements.messageInput.focus();
                } else {
                    this.elements.sendButton.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>Envoi...';
                }

                // R√©initialiser les ic√¥nes
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            },

            // Affichage de l'√©tat de chargement
            showLoadingState: function(loading) {
                if (this.elements.loadingMessages) {
                    if (loading) {
                        this.elements.loadingMessages.style.display = 'block';
                    } else {
                        this.elements.loadingMessages.style.display = 'none';
                    }
                }
            },

            // Mise √† jour du statut de connexion
            updateConnectionStatus: function(connected) {
                if (connected) {
                    this.elements.statusIndicator.className = 'w-2 h-2 rounded-full mr-2 bg-green-500';
                    this.elements.statusText.textContent = 'Connect√©';
                } else {
                    this.elements.statusIndicator.className = 'w-2 h-2 rounded-full mr-2 bg-red-500';
                    this.elements.statusText.textContent = 'Connexion perdue';
                }
            },

            // D√©marrage du polling
            startPolling: function() {
                if (this.refreshTimer) {
                    clearInterval(this.refreshTimer);
                }

                this.refreshTimer = setInterval(() => {
                    this.loadMessages(false);
                }, CHAT_CONFIG.refreshInterval);

                console.log('Polling d√©marr√© (intervalle:', CHAT_CONFIG.refreshInterval, 'ms)');
            },

            // Arr√™t du polling
            stopPolling: function() {
                if (this.refreshTimer) {
                    clearInterval(this.refreshTimer);
                    this.refreshTimer = null;
                    console.log('Polling arr√™t√©');
                }
            },

            // Scroll vers le bas (imm√©diat)
            scrollToBottom: function() {
                if (this.elements.messagesContainer) {
                    this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
                }
            },

            // Affichage d'une erreur
            showError: function(message) {
                // Cr√©er un √©l√©ment d'erreur temporaire
                const errorElement = document.createElement('div');
                errorElement.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
                errorElement.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>
                    <span>${this.escapeHtml(message)}</span>
                </div>
            `;

                // Ins√©rer l'erreur avant le formulaire
                this.elements.chatForm.parentNode.insertBefore(errorElement, this.elements.chatForm);

                // R√©initialiser les ic√¥nes
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Supprimer l'erreur apr√®s 5 secondes
                setTimeout(() => {
                    if (errorElement.parentNode) {
                        errorElement.parentNode.removeChild(errorElement);
                    }
                }, 5000);
            },

            // Formatage de la date
            formatDate: function(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) {
                    return '√Ä l\'instant';
                } else if (diffMins < 60) {
                    return `Il y a ${diffMins} min`;
                } else if (diffHours < 24) {
                    return `Il y a ${diffHours}h`;
                } else if (diffDays < 7) {
                    return `Il y a ${diffDays}j`;
                } else {
                    return date.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            },

            // √âchappement HTML
            escapeHtml: function(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            },

            // Nettoyage lors de la destruction
            destroy: function() {
                this.stopPolling();
                console.log('üßπ Chat nettoy√©');
            }
        };

        // Exposer l'API du chat globalement
        window.chatApp = chatApp;

        function shouldInitializeChat() {
            const chatSection = document.getElementById('chat-section');
            const messagesList = document.getElementById('messages-list');
            const hasValidMember = CHAT_CONFIG.memberId && CHAT_CONFIG.memberId !== 'null';
            const hasValidCourse = CHAT_CONFIG.courseId && CHAT_CONFIG.courseId !== 'null';

            return chatSection && messagesList && hasValidMember && hasValidCourse;
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if (shouldInitializeChat()) {
                    chatApp.init();
                } else {
                    console.log('Chat non initialis√© - Conditions non remplies');
                }
            });
        } else {
            setTimeout(() => {
                if (shouldInitializeChat()) {
                    chatApp.init();
                } else {
                    console.log('Chat non initialis√© - Conditions non remplies');
                }
            }, 100);
        }

        // Nettoyage lors du d√©chargement de la page
        window.addEventListener('beforeunload', function() {
            chatApp.destroy();
        });

    })();

    // Fonction globale pour afficher le message original
    function toggleOriginalMessage(messageId) {
        const originalDiv = document.getElementById(`original-message-${messageId}`);
        const toggleButton = document.querySelector(`button[onclick="toggleOriginalMessage(${messageId})"]`);

        if (originalDiv && toggleButton) {
            if (originalDiv.classList.contains('hidden')) {
                originalDiv.classList.remove('hidden');
                toggleButton.textContent = 'Masquer le message original';
            } else {
                originalDiv.classList.add('hidden');
                toggleButton.textContent = 'Afficher le message original';
            }
        }
    }

    // Fonction pour basculer le contenu du chat (masquer/afficher le contenu)
    function toggleChatContent() {
        const chatContent = document.getElementById('chat-content');
        const toggleBtn = document.getElementById('toggle-chat-content-btn');
        const toggleText = document.getElementById('chat-toggle-text');
        const chevronIcon = toggleBtn.querySelector('i[data-lucide]');

        if (chatContent && toggleBtn && toggleText) {
            if (chatContent.style.display === 'none') {
                // Afficher le contenu
                chatContent.style.display = 'block';
                toggleText.textContent = 'R√©duire';
                chevronIcon.setAttribute('data-lucide', 'chevron-up');
            } else {
                // Masquer le contenu
                chatContent.style.display = 'none';
                toggleText.textContent = 'D√©velopper';
                chevronIcon.setAttribute('data-lucide', 'chevron-down');
            }

            // R√©initialiser les ic√¥nes Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    }
</script>

<!-- Scripts JavaScript pour le chat -->
<script th:inline="javascript">
    // Configuration Thymeleaf inject√©e
    const CHAT_CONFIG = {
        courseId: /*[[${courseId}]]*/ null,
        memberId: /*[[${member != null ? member.id : 'null'}]]*/ null,
        memberName: /*[[${member != null ? member.firstname + ' ' + member.name : 'Utilisateur'}]]*/ 'Utilisateur',
        memberRole: /*[[${member != null ? member.role : 'RUNNER'}]]*/ 'RUNNER',
        refreshInterval: 3000,
        maxMessages: 100
    };
</script>
<script src="/js/chat.js"></script>

</body>
</html>